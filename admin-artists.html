<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arclead Artists Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .admin-section {
            padding: 30px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .control-group h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-success { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-small { padding: 8px 15px; font-size: 14px; margin: 2px; }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-control:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        textarea.form-control {
            height: 100px;
            resize: vertical;
        }

        .artists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .artist-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .artist-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .artist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .artist-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.2em;
        }

        .artist-images {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .artist-image {
            max-width: 80px;
            max-height: 60px;
            object-fit: contain;
            border-radius: 5px;
            border: 2px solid #ddd;
            background: #f8f9fa;
        }

        .filmography-section {
            margin-top: 10px;
        }

        .filmography-category {
            margin-bottom: 10px;
        }

        .category-title {
            font-weight: bold;
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .works-list {
            font-size: 0.8em;
            color: #555;
            line-height: 1.4;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .filmography-input {
            margin-bottom: 15px;
        }

        .year-works {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-start;
        }

        .year-input {
            width: 80px;
            flex-shrink: 0;
        }

        .works-input {
            flex: 1;
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .artists-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 2% auto;
                padding: 20px;
            }
        }

        .representative-images {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 10px;
        }

        .image-select {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .image-select label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
        }

        .image-select select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        /* ëŒ€í‘œ ì´ë¯¸ì§€ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .representative-image-preview {
            position: relative;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .representative-image-preview:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .representative-image-preview img {
            transition: box-shadow 0.2s ease;
        }

        .representative-image-preview:hover img {
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .representative-label {
            font-size: 0.7em;
            margin-top: 2px;
            font-weight: bold;
        }

        .unset-representative {
            width: 50px;
            height: 50px;
            background: #e9ecef;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed #adb5bd;
            transition: background-color 0.2s ease;
        }

        .unset-representative:hover {
            background: #dee2e6;
        }

        /* ì´ë¯¸ì§€ ì„ íƒ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .image-selection-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e9ecef;
        }

        .image-checkbox {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 10;
        }

        .image-preview-container {
            position: relative;
            display: inline-block;
            margin: 5px;
            transition: transform 0.2s ease;
        }

        .image-preview-container:hover {
            transform: scale(1.05);
        }

        .image-preview-container.selected {
            transform: scale(1.05);
        }

        .image-preview-container.selected img {
            border-color: #dc3545 !important;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }

        .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .selection-info {
            font-size: 14px;
            color: #495057;
        }

        .selection-actions {
            display: flex;
            gap: 10px;
        }

        .btn-outline-danger {
            background: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        .btn-outline-danger:hover {
            background: #dc3545;
            color: white;
        }

        .btn-outline-secondary {
            background: transparent;
            color: #6c757d;
            border: 1px solid #6c757d;
        }

        .btn-outline-secondary:hover {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ Arclead Artists Admin</h1>
            <p>ì•„í‹°ìŠ¤íŠ¸ ì •ë³´ ë° í•„ëª¨ê·¸ë˜í”¼ ê´€ë¦¬</p>
        </div>

        <div class="admin-section">
            <div class="status" id="status"></div>
            
            <div class="controls">
                <div class="control-group">
                    <h3>ğŸ‘¥ ì•„í‹°ìŠ¤íŠ¸ ê´€ë¦¬</h3>
                    <button class="btn btn-primary" onclick="openAddArtistModal()">â• ìƒˆ ì•„í‹°ìŠ¤íŠ¸ ì¶”ê°€</button>
                    <button class="btn" onclick="manualRefresh()">ğŸ”„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                </div>

                <div class="control-group">
                    <h3>ğŸ“Š í†µê³„</h3>
                    <p id="artistStats">ì´ ì•„í‹°ìŠ¤íŠ¸: <span id="totalArtists">0</span>ëª…</p>
                    <button class="btn btn-warning" onclick="exportData()">ğŸ“ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn btn-success" onclick="document.getElementById('importFile').click()">ğŸ“‚ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
                    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(this)">
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ì²˜ë¦¬ ì¤‘...</p>
            </div>

            <div id="artistsContainer">
                <h3>ğŸ¬ ë“±ë¡ëœ ì•„í‹°ìŠ¤íŠ¸</h3>
                <div class="artists-grid" id="artistsGrid">
                    <!-- Artists will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Artist Modal -->
    <div id="artistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ì•„í‹°ìŠ¤íŠ¸ ì¶”ê°€</h2>
                <span class="close" onclick="closeArtistModal()">&times;</span>
            </div>
            <form id="artistForm">
                <div class="form-group">
                    <label for="artistId">ì˜ë¬¸ëª…</label>
                    <input type="text" id="artistId" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="artistName">í™ˆí™”ë©´ í°ê¸€ì”¨</label>
                    <input type="text" id="artistName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="artistNameEn">í™ˆí™”ë©´ ì‘ì€ê¸€ì”¨</label>
                    <input type="text" id="artistNameEn" class="form-control">
                </div>

                <!-- ê¸°ì¡´ ì´ë¯¸ì§€ ê´€ë¦¬ ì„¹ì…˜ (ìˆ˜ì • ì‹œì—ë§Œ í‘œì‹œ) -->
                <div id="existingImagesSection" class="form-group" style="display: none;">
                    <label>ê¸°ì¡´ ì—…ë¡œë“œ ì´ë¯¸ì§€ ê´€ë¦¬</label>
                    <div class="image-selection-area">
                        <div class="selection-controls">
                            <div class="selection-info">
                                <span id="selectedCount">0</span>ê°œ ì„ íƒë¨ / ì´ <span id="totalImages">0</span>ê°œ
                            </div>
                            <div class="selection-actions">
                                <button type="button" class="btn btn-small btn-outline-secondary" onclick="toggleAllSelection()">
                                    <span id="toggleAllText">ì „ì²´ ì„ íƒ</span>
                                </button>
                                <button type="button" class="btn btn-small btn-outline-danger" onclick="deleteSelectedImages()" id="deleteSelectedBtn" disabled>
                                    ğŸ—‘ï¸ ì„ íƒëœ ì´ë¯¸ì§€ ì‚­ì œ
                                </button>
                            </div>
                        </div>
                        <div id="existingImagePreview">
                            <!-- Existing images will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="artistImages">ìƒˆ ì´ë¯¸ì§€ íŒŒì¼ ì—…ë¡œë“œ</label>
                    <input type="file" id="artistImages" class="form-control" multiple accept="image/*" onchange="handleImageSelection(this)">
                    <small>ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ê° íŒŒì¼ ìµœëŒ€ 50MB, ì›ë³¸ í’ˆì§ˆ ìœ ì§€, 5MB ì´ìƒ íŒŒì¼ë§Œ ìµœì†Œ ì••ì¶•)</small>
                    <div id="imagePreview" style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;"></div>
                </div>

                <div class="form-group">
                    <label>ëŒ€í‘œ ì´ë¯¸ì§€ ì„ íƒ</label>
                    <div class="representative-images">
                        <div class="image-select">
                            <label>í™ˆí™”ë©´ ëŒ€í‘œ ì´ë¯¸ì§€</label>
                            <select id="homeImage" class="form-control">
                                <option value="">ì„ íƒ ì•ˆí•¨</option>
                            </select>
                        </div>
                        <div class="image-select">
                            <label>Artists í™”ë©´ ëŒ€í‘œ ì´ë¯¸ì§€</label>
                            <select id="artistsImage" class="form-control">
                                <option value="">ì„ íƒ ì•ˆí•¨</option>
                            </select>
                        </div>
                    </div>
                </div>

                <h4>í•„ëª¨ê·¸ë˜í”¼</h4>
                
                <div class="filmography-input">
                    <h5>ì˜í™”</h5>
                    <div id="moviesContainer">
                        <div class="year-works">
                            <input type="text" class="form-control year-input" placeholder="ë…„ë„">
                            <textarea class="form-control works-input" placeholder="ì‘í’ˆëª… (ì—¬ëŸ¬ ì‘í’ˆì€ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)"></textarea>
                        </div>
                    </div>
                    <button type="button" class="btn btn-small" onclick="addYearWorks('moviesContainer')">+ ë…„ë„ ì¶”ê°€</button>
                </div>

                <div class="filmography-input">
                    <h5>ë“œë¼ë§ˆ</h5>
                    <div id="dramasContainer">
                        <div class="year-works">
                            <input type="text" class="form-control year-input" placeholder="ë…„ë„">
                            <textarea class="form-control works-input" placeholder="ì‘í’ˆëª… (ì—¬ëŸ¬ ì‘í’ˆì€ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)"></textarea>
                        </div>
                    </div>
                    <button type="button" class="btn btn-small" onclick="addYearWorks('dramasContainer')">+ ë…„ë„ ì¶”ê°€</button>
                </div>

                <div class="filmography-input">
                    <h5>ê´‘ê³ </h5>
                    <div id="commercialsContainer">
                        <div class="year-works">
                            <input type="text" class="form-control year-input" placeholder="ë…„ë„">
                            <textarea class="form-control works-input" placeholder="ì‘í’ˆëª… (ì—¬ëŸ¬ ì‘í’ˆì€ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)"></textarea>
                        </div>
                    </div>
                    <button type="button" class="btn btn-small" onclick="addYearWorks('commercialsContainer')">+ ë…„ë„ ì¶”ê°€</button>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-success">ğŸ’¾ ì €ì¥</button>
                    <button type="button" class="btn" onclick="closeArtistModal()">âŒ ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allArtists = [];
        let editingArtist = null;
        let processedImages = []; // ì²˜ë¦¬ëœ ì´ë¯¸ì§€ë“¤ì„ ì €ì¥

        // Show status message
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // Show/hide loading
        function setLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Load artists list
        async function refreshArtistsList() {
            try {
                console.log('Refreshing artists list...');
                const response = await fetch('/api/artists');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const newArtists = await response.json();
                console.log(`Loaded ${newArtists.length} artists`);
                
                allArtists = newArtists;
                renderArtists(allArtists);
                updateStats();
                
                return true; // Return success
            } catch (error) {
                console.error('Error loading artists:', error);
                showStatus('ì•„í‹°ìŠ¤íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                return false; // Return failure
            }
        }

        // Render artists
        function renderArtists(artists) {
            const grid = document.getElementById('artistsGrid');
            
            if (artists.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #6c757d; grid-column: 1/-1;">ë“±ë¡ëœ ì•„í‹°ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            console.log('Rendering', artists.length, 'artists');
            
            // Count artists with representative images
            const withHomeImages = artists.filter(a => a.representativeImages?.home).length;
            const withArtistImages = artists.filter(a => a.representativeImages?.artists).length;
            
            if (withHomeImages > 0 || withArtistImages > 0) {
                console.log(`ëŒ€í‘œ ì´ë¯¸ì§€ ì„¤ì • í˜„í™©: í™ˆí™”ë©´ ${withHomeImages}ê°œ, ì•„í‹°ìŠ¤íŠ¸ ${withArtistImages}ê°œ`);
            } else {
                console.log('ì„¤ì •ëœ ëŒ€í‘œ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }

            grid.innerHTML = artists.map(artist => {
                // Safely encode image URLs
                const safeArtistId = encodeURIComponent(artist.id);
                const homeImageUrl = artist.representativeImages?.home ? 
                    `/assets/artists/${safeArtistId}/${encodeURIComponent(artist.representativeImages.home)}` : null;
                const artistsImageUrl = artist.representativeImages?.artists ? 
                    `/assets/artists/${safeArtistId}/${encodeURIComponent(artist.representativeImages.artists)}` : null;
                
                return `
                <div class="artist-card">
                    <div class="artist-header">
                        <div class="artist-name">
                            ${artist.name}
                            ${(() => {
                                const hasHome = artist.representativeImages?.home;
                                const hasArtists = artist.representativeImages?.artists;
                                if (hasHome && hasArtists) {
                                    return '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; margin-left: 8px;">ëŒ€í‘œì´ë¯¸ì§€ ì™„ë£Œ</span>';
                                } else if (hasHome || hasArtists) {
                                    return '<span style="background: #ffc107; color: #212529; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; margin-left: 8px;">ëŒ€í‘œì´ë¯¸ì§€ ë¶€ë¶„ì„¤ì •</span>';
                                } else {
                                    return '<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; margin-left: 8px;">ëŒ€í‘œì´ë¯¸ì§€ ë¯¸ì„¤ì •</span>';
                                }
                            })()}
                        </div>
                        <div>
                            <button class="btn btn-warning btn-small" onclick="editArtist('${artist.id}')">âœï¸ ìˆ˜ì •</button>
                            <button class="btn btn-danger btn-small" onclick="deleteArtist('${artist.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
                        </div>
                    </div>
                    
                    <div><strong>ì˜ë¬¸ëª…:</strong> ${artist.id}</div>
                    ${artist.nameEn ? `<div><strong>í™ˆí™”ë©´ ì‘ì€ê¸€ì”¨:</strong> ${artist.nameEn}</div>` : ''}
                    
                    <!-- ëŒ€í‘œ ì´ë¯¸ì§€ ì„¹ì…˜ -->
                    <div class="representative-images-display" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px; font-size: 0.9em;">ğŸ“Œ ëŒ€í‘œ ì´ë¯¸ì§€</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${homeImageUrl ? `
                                <div class="representative-image-preview" style="text-align: center;">
                                    <img src="${homeImageUrl}" 
                                         style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 2px solid #28a745;" 
                                         alt="í™ˆí™”ë©´ ëŒ€í‘œ"
                                         title="í™ˆí™”ë©´ ëŒ€í‘œ ì´ë¯¸ì§€: ${artist.representativeImages.home}"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                         onload="this.style.border='2px solid #28a745';">
                                    <div style="display: none; width: 50px; height: 50px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 4px; border: 2px solid #ffc107; justify-content: center; align-items: center; color: #6c757d; font-size: 0.5em; text-align: center; line-height: 1;">
                                        íŒŒì¼<br>ì—†ìŒ
                                    </div>
                                    <div class="representative-label" style="color: #28a745;">í™ˆí™”ë©´</div>
                                </div>
                            ` : `
                                <div style="text-align: center;">
                                    <div class="unset-representative" title="í™ˆí™”ë©´ ëŒ€í‘œ ì´ë¯¸ì§€ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤">
                                        <span style="font-size: 0.7em; color: #6c757d;">ë¯¸ì§€ì •</span>
                                    </div>
                                    <div class="representative-label" style="color: #6c757d;">í™ˆí™”ë©´</div>
                                </div>
                            `}
                            ${artistsImageUrl ? `
                                <div class="representative-image-preview" style="text-align: center;">
                                    <img src="${artistsImageUrl}" 
                                         style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 2px solid #007bff;" 
                                         alt="ì•„í‹°ìŠ¤íŠ¸ í™”ë©´ ëŒ€í‘œ"
                                         title="ì•„í‹°ìŠ¤íŠ¸ í™”ë©´ ëŒ€í‘œ ì´ë¯¸ì§€: ${artist.representativeImages.artists}"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                         onload="this.style.border='2px solid #007bff';">
                                    <div style="display: none; width: 50px; height: 50px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 4px; border: 2px solid #ffc107; justify-content: center; align-items: center; color: #6c757d; font-size: 0.5em; text-align: center; line-height: 1;">
                                        íŒŒì¼<br>ì—†ìŒ
                                    </div>
                                    <div class="representative-label" style="color: #007bff;">ì•„í‹°ìŠ¤íŠ¸</div>
                                </div>
                            ` : `
                                <div style="text-align: center;">
                                    <div class="unset-representative" title="ì•„í‹°ìŠ¤íŠ¸ í™”ë©´ ëŒ€í‘œ ì´ë¯¸ì§€ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤">
                                        <span style="font-size: 0.7em; color: #6c757d;">ë¯¸ì§€ì •</span>
                                    </div>
                                    <div class="representative-label" style="color: #6c757d;">ì•„í‹°ìŠ¤íŠ¸</div>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- ì „ì²´ ì—…ë¡œë“œ ì´ë¯¸ì§€ ì„¹ì…˜ -->
                    <div class="all-images-display" style="margin: 15px 0;">
                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px; font-size: 0.9em;">ğŸ“¸ ì „ì²´ ì—…ë¡œë“œ ì´ë¯¸ì§€ (${(artist.images || []).length}ê°œ)</div>
                        <div class="artist-images">
                            ${(artist.images || []).slice(0, 4).map((img, index) => {
                                const isHomeRep = artist.representativeImages?.home === img;
                                const isArtistRep = artist.representativeImages?.artists === img;
                                let borderColor = '#ddd';
                                let badgeText = '';
                                let badgeColor = '';
                                
                                if (isHomeRep && isArtistRep) {
                                    borderColor = '#6f42c1';
                                    badgeText = 'í™ˆ+ì•„í‹°';
                                    badgeColor = '#6f42c1';
                                } else if (isHomeRep) {
                                    borderColor = '#28a745';
                                    badgeText = 'í™ˆ';
                                    badgeColor = '#28a745';
                                } else if (isArtistRep) {
                                    borderColor = '#007bff';
                                    badgeText = 'ì•„í‹°';
                                    badgeColor = '#007bff';
                                }
                                
                                const imageUrl = `/assets/artists/${safeArtistId}/${encodeURIComponent(img)}`;
                                
                                return `<div style="position: relative; display: inline-block; margin: 2px; width: 80px; height: 60px; background: #f8f9fa; border-radius: 5px; border: 2px solid ${borderColor}; display: flex; align-items: center; justify-content: center;">
                                    <img src="${imageUrl}" 
                                         style="max-width: 76px; max-height: 56px; object-fit: contain; border-radius: 3px;" 
                                         alt="${artist.name}"
                                         title="${img}${badgeText ? ' (' + badgeText + ' ëŒ€í‘œ)' : ''}"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div style="display: none; width: 76px; height: 56px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 3px; justify-content: center; align-items: center; color: #6c757d; font-size: 0.6em; text-align: center; line-height: 1; position: relative;">
                                        íŒŒì¼ì—†ìŒ
                                        <span style="position: absolute; top: 2px; left: 2px; background: rgba(0,0,0,0.7); color: white; border-radius: 2px; padding: 1px 4px; font-size: 0.7em;">${index + 1}</span>
                                        ${badgeText ? `<span style="position: absolute; bottom: 2px; right: 2px; background: ${badgeColor}; color: white; border-radius: 2px; padding: 1px 3px; font-size: 0.6em; font-weight: bold;">${badgeText}</span>` : ''}
                                    </div>
                                    <span style="position: absolute; top: 2px; left: 2px; background: rgba(0,0,0,0.7); color: white; border-radius: 2px; padding: 1px 4px; font-size: 0.7em;">${index + 1}</span>
                                    ${badgeText ? `<span style="position: absolute; bottom: 2px; right: 2px; background: ${badgeColor}; color: white; border-radius: 2px; padding: 1px 3px; font-size: 0.6em; font-weight: bold;">${badgeText}</span>` : ''}
                                </div>`;
                            }).join('')}
                            ${(artist.images || []).length > 4 ? `<div style="display: flex; align-items: center; color: #666;">+${(artist.images || []).length - 4}</div>` : ''}
                        </div>
                    </div>

                    <div class="filmography-section">
                        ${Object.entries(artist.filmography || {}).map(([category, works]) => {
                            const categoryName = { movies: 'ì˜í™”', dramas: 'ë“œë¼ë§ˆ', commercials: 'ê´‘ê³ ' }[category];
                            const workCount = Object.values(works).reduce((acc, workList) => acc + (Array.isArray(workList) ? workList.length : 1), 0);
                            return workCount > 0 ? `
                                <div class="filmography-category">
                                    <div class="category-title">${categoryName} (${workCount}í¸)</div>
                                    <div class="works-list">${Object.entries(works).slice(0, 2).map(([year, workList]) => 
                                        `${year}: ${Array.isArray(workList) ? workList[0] + (workList.length > 1 ? ' ì™¸ ' + (workList.length - 1) + 'í¸' : '') : workList}`
                                    ).join('<br>')}</div>
                                </div>
                            ` : '';
                        }).join('')}
                    </div>
                </div>
            `;
            }).join('');
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalArtists').textContent = allArtists.length;
        }

        // Open add artist modal
        function openAddArtistModal() {
            editingArtist = null;
            currentEditingArtist = null;
            selectedImages.clear();
            document.getElementById('modalTitle').textContent = 'ìƒˆ ì•„í‹°ìŠ¤íŠ¸ ì¶”ê°€';
            document.getElementById('artistForm').reset();
            document.getElementById('existingImagesSection').style.display = 'none';
            clearFilmographyContainers();
            document.getElementById('artistModal').style.display = 'block';
        }

        // Close artist modal
        function closeArtistModal() {
            document.getElementById('artistModal').style.display = 'none';
            editingArtist = null;
            currentEditingArtist = null;
            processedImages = [];
            selectedImages.clear();
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('existingImagePreview').innerHTML = '';
            document.getElementById('existingImagesSection').style.display = 'none';
        }

        // Clear filmography containers
        function clearFilmographyContainers() {
            ['moviesContainer', 'dramasContainer', 'commercialsContainer'].forEach(containerId => {
                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="year-works">
                        <input type="text" class="form-control year-input" placeholder="ë…„ë„">
                        <textarea class="form-control works-input" placeholder="ì‘í’ˆëª… (ì—¬ëŸ¬ ì‘í’ˆì€ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)"></textarea>
                    </div>
                `;
            });
        }

        // Add year-works input
        function addYearWorks(containerId) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'year-works';
            div.innerHTML = `
                <input type="text" class="form-control year-input" placeholder="ë…„ë„">
                <textarea class="form-control works-input" placeholder="ì‘í’ˆëª… (ì—¬ëŸ¬ ì‘í’ˆì€ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)"></textarea>
                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">âœ•</button>
            `;
            container.appendChild(div);
        }

        // Collect filmography data
        function collectFilmographyData() {
            const filmography = {};
            
            ['movies', 'dramas', 'commercials'].forEach(category => {
                const containerId = category + 'Container';
                const container = document.getElementById(containerId);
                const yearWorksElements = container.querySelectorAll('.year-works');
                
                console.log(`Collecting ${category} data from ${yearWorksElements.length} year-works elements`);
                
                filmography[category] = {};
                
                yearWorksElements.forEach((element, index) => {
                    const yearInput = element.querySelector('.year-input');
                    const worksInput = element.querySelector('.works-input');
                    
                    const year = yearInput.value.trim();
                    const works = worksInput.value.trim();
                    
                    console.log(`${category} element ${index + 1}: year="${year}", works="${works}"`);
                    
                    if (year && works) {
                        const workList = works.split('\n').map(w => w.trim()).filter(w => w);
                        filmography[category][year] = workList;
                        console.log(`Added to ${category}[${year}]:`, workList);
                    }
                });
                
                console.log(`Final ${category} data:`, filmography[category]);
            });
            
            console.log('Complete filmography data:', filmography);
            return filmography;
        }

        // Update image select options when images are processed
        function updateImageSelects() {
            const homeSelect = document.getElementById('homeImage');
            const artistsSelect = document.getElementById('artistsImage');
            
            // Clear existing options except the first one
            while (homeSelect.options.length > 1) homeSelect.remove(1);
            while (artistsSelect.options.length > 1) artistsSelect.remove(1);
            
            // Add new options for each processed image
            processedImages.forEach((file, index) => {
                const option = document.createElement('option');
                option.value = file.name;
                option.textContent = `${index + 1}ë²ˆ ì´ë¯¸ì§€`;
                homeSelect.add(option.cloneNode(true));
                artistsSelect.add(option);
            });
        }

        // Update image select options with existing images
        function updateImageSelectsWithExisting(existingImages) {
            const homeSelect = document.getElementById('homeImage');
            const artistsSelect = document.getElementById('artistsImage');
            
            // Clear existing options except the first one
            while (homeSelect.options.length > 1) homeSelect.remove(1);
            while (artistsSelect.options.length > 1) artistsSelect.remove(1);
            
            // Add options for existing images
            existingImages.forEach((img, index) => {
                const option = document.createElement('option');
                option.value = img;
                option.textContent = `${index + 1}ë²ˆ ì´ë¯¸ì§€ (ê¸°ì¡´)`;
                homeSelect.add(option.cloneNode(true));
                artistsSelect.add(option);
            });

            // Add options for new processed images
            processedImages.forEach((file, index) => {
                const option = document.createElement('option');
                option.value = file.name;
                const imageNumber = existingImages.length + index + 1;
                option.textContent = `${imageNumber}ë²ˆ ì´ë¯¸ì§€ (ìƒˆë¡œ ì—…ë¡œë“œ)`;
                homeSelect.add(option.cloneNode(true));
                artistsSelect.add(option);
            });
        }

        // Multi-selection variables
        let selectedImages = new Set();
        let currentEditingArtist = null;

        // Toggle image selection
        function toggleImageSelection(imageName, checkbox) {
            if (checkbox.checked) {
                selectedImages.add(imageName);
            } else {
                selectedImages.delete(imageName);
            }
            updateSelectionUI();
        }

        // Update selection UI
        function updateSelectionUI() {
            document.getElementById('selectedCount').textContent = selectedImages.size;
            
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            deleteBtn.disabled = selectedImages.size === 0;
            
            const totalImages = document.querySelectorAll('.image-checkbox').length;
            const toggleAllBtn = document.getElementById('toggleAllText');
            
            if (selectedImages.size === totalImages && totalImages > 0) {
                toggleAllBtn.textContent = 'ì „ì²´ í•´ì œ';
            } else {
                toggleAllBtn.textContent = 'ì „ì²´ ì„ íƒ';
            }

            // Update visual selection state
            document.querySelectorAll('.image-preview-container').forEach(container => {
                const checkbox = container.querySelector('.image-checkbox');
                if (checkbox && selectedImages.has(checkbox.value)) {
                    container.classList.add('selected');
                } else {
                    container.classList.remove('selected');
                }
            });
        }

        // Toggle all selection
        function toggleAllSelection() {
            const checkboxes = document.querySelectorAll('.image-checkbox');
            const shouldSelectAll = selectedImages.size < checkboxes.length;
            
            selectedImages.clear();
            checkboxes.forEach(checkbox => {
                checkbox.checked = shouldSelectAll;
                if (shouldSelectAll) {
                    selectedImages.add(checkbox.value);
                }
            });
            
            updateSelectionUI();
        }

        // Delete selected images - Simplified version that updates artist data directly
        async function deleteSelectedImages() {
            if (selectedImages.size === 0) {
                showStatus('ì‚­ì œí•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const imageNames = Array.from(selectedImages);
            const confirmMsg = `ì„ íƒëœ ${imageNames.length}ê°œì˜ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${imageNames.join('\n')}\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
            
            if (!confirm(confirmMsg)) return;

            setLoading(true);

            try {
                console.log('Starting image deletion process...');
                console.log('Images to delete:', imageNames);
                
                // Get current artist data
                const artist = allArtists.find(a => a.id === currentEditingArtist);
                if (!artist) {
                    throw new Error('Artist not found in local data');
                }

                // Remove deleted images from artist's image list
                const originalImageCount = artist.images ? artist.images.length : 0;
                const updatedImages = artist.images ? 
                    artist.images.filter(img => !imageNames.includes(img)) : [];
                
                console.log(`Original images: ${originalImageCount}, After deletion: ${updatedImages.length}`);

                // Check if representative images need to be updated
                let representativeImages = { ...artist.representativeImages };
                let repImageUpdated = false;

                if (representativeImages?.home && imageNames.includes(representativeImages.home)) {
                    console.log(`Removing home representative image: ${representativeImages.home}`);
                    representativeImages.home = null;
                    repImageUpdated = true;
                }

                if (representativeImages?.artists && imageNames.includes(representativeImages.artists)) {
                    console.log(`Removing artists representative image: ${representativeImages.artists}`);
                    representativeImages.artists = null;
                    repImageUpdated = true;
                }

                // Prepare updated artist data
                const updatedArtistData = {
                    id: artist.id,
                    name: artist.name,
                    nameEn: artist.nameEn || '',
                    filmography: artist.filmography || {},
                    representativeImages: representativeImages
                };

                console.log('Sending comprehensive update to server...', {
                    artistData: updatedArtistData,
                    deletedImages: imageNames,
                    remainingImages: updatedImages
                });

                // Create FormData for the update - let server handle both data update and file deletion
                const formData = new FormData();
                formData.append('artistData', JSON.stringify(updatedArtistData));
                formData.append('deletedImages', JSON.stringify(imageNames));

                // Send update to server - this will handle both R2 deletion and data update
                const response = await fetch(`/api/artists/${currentEditingArtist}`, {
                    method: 'PUT',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server response error:', errorText);
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: HTTP ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('Server response:', result);

                // Update local data
                artist.images = updatedImages;
                artist.representativeImages = representativeImages;

                // Update UI
                imageNames.forEach(imageName => {
                    const container = document.querySelector(`input[value="${imageName}"]`)?.closest('.image-preview-container');
                    if (container) {
                        container.remove();
                    }
                });

                // Update representative image selects if needed
                if (repImageUpdated) {
                    updateImageSelectsWithExisting(updatedImages);
                    
                    // Update select values
                    const homeSelect = document.getElementById('homeImage');
                    const artistsSelect = document.getElementById('artistsImage');
                    homeSelect.value = representativeImages.home || '';
                    artistsSelect.value = representativeImages.artists || '';
                }

                // Clear selection and update UI
                selectedImages.clear();
                updateSelectionUI();

                // Update total images count
                const totalImages = document.querySelectorAll('.image-checkbox').length;
                document.getElementById('totalImages').textContent = totalImages;

                setLoading(false);

                let successMsg = `${imageNames.length}ê°œì˜ ì´ë¯¸ì§€ê°€ ì™„ì „íˆ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`;
                if (repImageUpdated) {
                    successMsg += ' ëŒ€í‘œ ì´ë¯¸ì§€ ì„¤ì •ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.';
                }
                showStatus(successMsg, 'success');

                console.log('Image deletion completed successfully');

            } catch (error) {
                console.error('Error during image deletion:', error);
                setLoading(false);
                
                showStatus(`ì´ë¯¸ì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
                
                // Force refresh to get the correct state from server
                console.log('Forcing refresh due to error...');
                await refreshArtistsList();
                
                // Re-open the edit modal to show current state
                if (currentEditingArtist) {
                    setTimeout(() => editArtist(currentEditingArtist), 100);
                }
            }
        }

        // Modify handleImageSelection to update selects
        async function handleImageSelection(input) {
            const files = Array.from(input.files);
            const preview = document.getElementById('imagePreview');
            processedImages = [];

            if (files.length === 0) return;

            // Check for duplicate filenames if editing existing artist
            if (editingArtist) {
                const artist = allArtists.find(a => a.id === editingArtist);
                if (artist && artist.images) {
                    const duplicateFiles = files.filter(file => 
                        artist.images.some(existingImg => 
                            existingImg.toLowerCase() === file.name.toLowerCase()
                        )
                    );
                    
                    if (duplicateFiles.length > 0) {
                        showStatus(`ë‹¤ìŒ íŒŒì¼ëª…ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: ${duplicateFiles.map(f => f.name).join(', ')}`, 'error');
                        input.value = '';
                        return;
                    }
                }
            }

            showStatus('ì´ë¯¸ì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘...', 'info');

            // Clear existing preview except for existing images when editing
            if (!editingArtist) {
                preview.innerHTML = '';
            } else {
                // Only remove new image previews, keep existing ones
                const newImagePreviews = preview.querySelectorAll('[data-new-image]');
                newImagePreviews.forEach(div => div.remove());
            }

            for (const file of files) {
                try {
                    if (file.size > 50 * 1024 * 1024) {
                        showStatus(`${file.name}ì€ ë„ˆë¬´ í½ë‹ˆë‹¤ (50MB ì´ˆê³¼). ê±´ë„ˆëœë‹ˆë‹¤.`, 'error');
                        continue;
                    }

                    // ì›ë³¸ í’ˆì§ˆ ë³´ì¡´ - ë¦¬ì‚¬ì´ì¦ˆ ì—†ì´ ì§ì ‘ ì‚¬ìš©í•˜ê±°ë‚˜ ìµœì†Œí•œì˜ ì••ì¶•ë§Œ ì ìš©
                    let processedFile;
                    if (file.size > 5 * 1024 * 1024) { // 5MB ì´ìƒì¸ ê²½ìš°ë§Œ ì••ì¶•
                        console.log(`Large file detected (${(file.size / 1024 / 1024).toFixed(1)}MB): ${file.name}, applying minimal compression`);
                        processedFile = await resizeImage(file, 2048, 2048, 0.95); // ê³ í•´ìƒë„, ê³ í’ˆì§ˆ ìœ ì§€
                    } else {
                        console.log(`Using original file: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`);
                        processedFile = file; // ì›ë³¸ íŒŒì¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    }
                    processedImages.push(processedFile);

                    // Create preview
                    const previewDiv = document.createElement('div');
                    previewDiv.style.cssText = 'position: relative; display: inline-block; margin: 5px;';
                    previewDiv.setAttribute('data-new-image', 'true'); // Mark as new image
                    
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(processedFile);
                    img.style.cssText = 'max-width: 100px; max-height: 80px; object-fit: contain; border-radius: 5px; border: 2px solid #28a745; background: #f8f9fa;'; // Green border for new images
                    
                    // Calculate image number (existing images + new images)
                    const existingImagesCount = editingArtist ? 
                        (allArtists.find(a => a.id === editingArtist)?.images?.length || 0) : 0;
                    const newImageNumber = existingImagesCount + processedImages.length;
                    
                    const numberLabel = document.createElement('div');
                    numberLabel.textContent = newImageNumber.toString();
                    numberLabel.style.cssText = 'position: absolute; top: 2px; left: 2px; background: rgba(40,167,69,0.9); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;';
                    
                    const sizeSpan = document.createElement('span');
                    sizeSpan.textContent = `${(processedFile.size / 1024).toFixed(1)}KB`;
                    sizeSpan.style.cssText = 'position: absolute; bottom: -15px; left: 0; font-size: 10px; color: #666;';
                    
                    previewDiv.appendChild(img);
                    previewDiv.appendChild(numberLabel);
                    previewDiv.appendChild(sizeSpan);
                    preview.appendChild(previewDiv);
                } catch (error) {
                    console.error('Error processing image:', error);
                    showStatus(`ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                }
            }

            // Update image select options
            if (editingArtist) {
                const artist = allArtists.find(a => a.id === editingArtist);
                const existingImages = artist && artist.images ? artist.images : [];
                updateImageSelectsWithExisting(existingImages);
            } else {
                updateImageSelects();
            }
        }

        // ê³ í’ˆì§ˆ ì´ë¯¸ì§€ ì²˜ë¦¬ í•¨ìˆ˜ - ì›ë³¸ í˜•ì‹ê³¼ í’ˆì§ˆ ìµœëŒ€í•œ ë³´ì¡´
        function resizeImage(file, maxWidth, maxHeight, quality) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                // ì›ë³¸ íŒŒì¼ì˜ MIME íƒ€ì… í™•ì¸
                const originalType = file.type;
                const isJPEG = originalType.includes('jpeg') || originalType.includes('jpg');
                const isPNG = originalType.includes('png');
                const isWebP = originalType.includes('webp');

                console.log(`Processing image: ${file.name}, Type: ${originalType}, Size: ${(file.size / 1024).toFixed(1)}KB`);

                img.onload = function() {
                    let { width, height } = img;
                    const originalWidth = width;
                    const originalHeight = height;
                    
                    // ë¦¬ì‚¬ì´ì¦ˆê°€ í•„ìš”í•œì§€ í™•ì¸
                    const needsResize = width > maxWidth || height > maxHeight;
                    
                    if (needsResize) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width *= ratio;
                        height *= ratio;
                        console.log(`Resizing from ${originalWidth}x${originalHeight} to ${Math.round(width)}x${Math.round(height)}`);
                    } else {
                        console.log(`No resize needed: ${width}x${height} fits within ${maxWidth}x${maxHeight}`);
                    }

                    canvas.width = width;
                    canvas.height = height;

                    // ê³ í’ˆì§ˆ ë Œë”ë§ ì„¤ì •
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ì›ë³¸ í˜•ì‹ ìœ ì§€í•˜ë˜, í’ˆì§ˆ ì„¤ì •
                    let outputType = originalType;
                    let outputQuality = quality;

                    // PNGëŠ” ë¬´ì†ì‹¤ì´ë¯€ë¡œ í’ˆì§ˆ ì„¤ì • ë¶ˆí•„ìš”
                    if (isPNG) {
                        outputType = 'image/png';
                        outputQuality = undefined; // PNGëŠ” quality íŒŒë¼ë¯¸í„° ë¬´ì‹œ
                        console.log('Maintaining PNG format (lossless)');
                    } else if (isWebP) {
                        outputType = 'image/webp';
                        console.log(`Maintaining WebP format with quality ${quality}`);
                    } else {
                        // JPEG ë˜ëŠ” ê¸°íƒ€ í˜•ì‹ì€ JPEGë¡œ ë³€í™˜
                        outputType = 'image/jpeg';
                        console.log(`Converting to JPEG with quality ${quality}`);
                    }
                    
                    canvas.toBlob(
                        (blob) => {
                            if (blob) {
                                const processedFile = new File([blob], file.name, {
                                    type: outputType,
                                    lastModified: Date.now()
                                });
                                
                                const compressionRatio = ((file.size - processedFile.size) / file.size * 100).toFixed(1);
                                console.log(`Processed ${file.name}: ${(file.size / 1024).toFixed(1)}KB â†’ ${(processedFile.size / 1024).toFixed(1)}KB (${compressionRatio}% reduction)`);
                                
                                resolve(processedFile);
                            } else {
                                reject(new Error('Failed to process image'));
                            }
                        },
                        outputType,
                        outputQuality
                    );
                };

                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = URL.createObjectURL(file);
            });
        }

        // Modify form submission to include representative images
        document.getElementById('artistForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const newArtistId = document.getElementById('artistId').value.trim();
            const homeImageValue = document.getElementById('homeImage').value;
            const artistsImageValue = document.getElementById('artistsImage').value;
            
            const filmographyData = collectFilmographyData();
            
            const artistData = {
                id: newArtistId,
                name: document.getElementById('artistName').value.trim(),
                nameEn: document.getElementById('artistNameEn').value.trim(),
                filmography: filmographyData,
                representativeImages: {
                    home: homeImageValue || null,
                    artists: artistsImageValue || null
                }
            };

            // Debug log for all data being saved
            console.log('=== Saving artist data ===');
            console.log('Artist ID:', newArtistId);
            console.log('Artist Name:', artistData.name);
            console.log('Artist Name EN:', artistData.nameEn);
            console.log('Filmography data:', filmographyData);
            console.log('Representative images:', {
                home: homeImageValue,
                artists: artistsImageValue,
                editingArtist: editingArtist
            });
            console.log('Complete artist data:', artistData);

            // If editing, check if representative images actually changed
            if (editingArtist) {
                const currentArtist = allArtists.find(a => a.id === editingArtist);
                if (currentArtist) {
                    const currentHome = currentArtist.representativeImages?.home || '';
                    const currentArtists = currentArtist.representativeImages?.artists || '';
                    console.log('Current representative images:', {
                        home: currentHome,
                        artists: currentArtists
                    });
                    console.log('Representative images changed:', {
                        homeChanged: currentHome !== homeImageValue,
                        artistsChanged: currentArtists !== artistsImageValue
                    });
                }
            }

            // Validate ID format
            if (!/^[a-zA-Z0-9\-]+$/.test(artistData.id)) {
                showStatus('ì˜ë¬¸ëª…ì€ ì˜ë¬¸, ìˆ«ì, - ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // Check for duplicate ID (when adding new or changing existing ID)
            const isIdChanged = editingArtist && editingArtist !== newArtistId;
            if ((!editingArtist || isIdChanged) && allArtists.some(a => a.id === newArtistId)) {
                showStatus('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì˜ë¬¸ëª…ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            formData.append('artistData', JSON.stringify(artistData));
            
            // Add processed images instead of original files
            if (processedImages.length > 0) {
                for (let i = 0; i < processedImages.length; i++) {
                    formData.append('images', processedImages[i]);
                }
                console.log(`Uploading ${processedImages.length} processed images`);
            }

            setLoading(true);
            try {
                const url = editingArtist ? `/api/artists/${editingArtist}` : '/api/artists';
                const method = editingArtist ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('=== Server response ===');
                console.log('Response:', result);
                console.log('Saved artist:', result.artist);
                
                // Update local artist data immediately
                if (editingArtist) {
                    const artistIndex = allArtists.findIndex(a => a.id === (isIdChanged ? editingArtist : newArtistId));
                    if (artistIndex !== -1) {
                        const oldData = { ...allArtists[artistIndex] };
                        allArtists[artistIndex] = { ...allArtists[artistIndex], ...artistData };
                        console.log('=== Local data update ===');
                        console.log('Old data:', oldData);
                        console.log('New data:', allArtists[artistIndex]);
                        console.log('Filmography comparison:');
                        console.log('Old filmography:', oldData.filmography);
                        console.log('New filmography:', allArtists[artistIndex].filmography);
                    }
                } else {
                    console.log('=== New artist created ===');
                    console.log('Artist data:', result.artist);
                }
                
                showStatus(editingArtist ? 'ì•„í‹°ìŠ¤íŠ¸ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìƒˆ ì•„í‹°ìŠ¤íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                // If ID was changed, update the editingArtist reference
                if (editingArtist && isIdChanged) {
                    editingArtist = newArtistId;
                }
                
                closeArtistModal();
                refreshArtistsList();
                
            } catch (error) {
                console.error('Error saving artist:', error);
                if (error.message.includes('413')) {
                    showStatus('ì—…ë¡œë“œ íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ ë” ì‘ê²Œ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.', 'error');
                } else if (error.message.includes('409')) {
                    showStatus('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì˜ë¬¸ëª…ì…ë‹ˆë‹¤.', 'error');
                } else {
                    showStatus('ì•„í‹°ìŠ¤íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                }
            }
            setLoading(false);
        });

        // Modify editArtist function to set representative images
        async function editArtist(artistId) {
            const artist = allArtists.find(a => a.id === artistId);
            if (!artist) return;

            editingArtist = artistId;
            currentEditingArtist = artistId;
            selectedImages.clear(); // Clear previous selections
            
            document.getElementById('modalTitle').textContent = 'ì•„í‹°ìŠ¤íŠ¸ ìˆ˜ì •';
            
            // Fill form
            document.getElementById('artistId').value = artist.id;
            document.getElementById('artistName').value = artist.name;
            document.getElementById('artistNameEn').value = artist.nameEn || '';
            
            // Show existing images section
            const existingImagesSection = document.getElementById('existingImagesSection');
            const existingImagePreview = document.getElementById('existingImagePreview');
            
            // Clear new images preview and reset processed images
            const newImagePreview = document.getElementById('imagePreview');
            newImagePreview.innerHTML = '';
            processedImages = []; // Reset processed images
            
            if (artist.images && artist.images.length > 0) {
                existingImagesSection.style.display = 'block';
                existingImagePreview.innerHTML = '';
                
                // Update total images count
                document.getElementById('totalImages').textContent = artist.images.length;
                
                artist.images.forEach((img, index) => {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'image-preview-container';
                    
                    const imgElement = document.createElement('img');
                    imgElement.src = `/assets/artists/${artist.id}/${img}`;
                    imgElement.style.cssText = 'max-width: 100px; max-height: 80px; object-fit: contain; border-radius: 5px; border: 2px solid #ddd; background: #f8f9fa;';
                    
                    const numberLabel = document.createElement('div');
                    numberLabel.textContent = (index + 1).toString();
                    numberLabel.style.cssText = 'position: absolute; top: 2px; left: 2px; background: rgba(0,0,0,0.7); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'image-checkbox';
                    checkbox.value = img;
                    checkbox.title = 'ì‚­ì œí•  ì´ë¯¸ì§€ ì„ íƒ';
                    checkbox.onchange = function() {
                        toggleImageSelection(img, this);
                    };
                    
                    // Add filename label
                    const filename = document.createElement('div');
                    filename.textContent = img.length > 20 ? img.substring(0, 17) + '...' : img;
                    filename.style.cssText = 'position: absolute; bottom: -15px; left: 0; font-size: 10px; color: #666; max-width: 100px; text-align: center; word-break: break-all;';
                    filename.title = img;
                    
                    previewDiv.appendChild(imgElement);
                    previewDiv.appendChild(numberLabel);
                    previewDiv.appendChild(checkbox);
                    previewDiv.appendChild(filename);
                    existingImagePreview.appendChild(previewDiv);
                });

                // Update image select options with existing images first
                updateImageSelectsWithExisting(artist.images);
                
                // Then set representative images if they exist (after options are created)
                setTimeout(() => {
                    if (artist.representativeImages) {
                        const homeSelect = document.getElementById('homeImage');
                        const artistsSelect = document.getElementById('artistsImage');
                        
                        console.log('Setting representative images:', artist.representativeImages);
                        console.log('Available home options:', Array.from(homeSelect.options).map(o => o.value));
                        console.log('Available artists options:', Array.from(artistsSelect.options).map(o => o.value));
                        
                        if (artist.representativeImages.home) {
                            homeSelect.value = artist.representativeImages.home;
                            console.log('Set home image to:', homeSelect.value);
                        }
                        if (artist.representativeImages.artists) {
                            artistsSelect.value = artist.representativeImages.artists;
                            console.log('Set artists image to:', artistsSelect.value);
                        }
                    }
                }, 100);
            } else {
                existingImagesSection.style.display = 'none';
                
                // Clear select options if no images
                const homeSelect = document.getElementById('homeImage');
                const artistsSelect = document.getElementById('artistsImage');
                
                while (homeSelect.options.length > 1) homeSelect.remove(1);
                while (artistsSelect.options.length > 1) artistsSelect.remove(1);
            }
            
            // Initialize selection UI
            updateSelectionUI();
            
            // Clear and fill filmography
            clearFilmographyContainers();
            
            if (artist.filmography) {
                Object.entries(artist.filmography).forEach(([category, works]) => {
                    const containerId = category + 'Container';
                    const container = document.getElementById(containerId);
                    container.innerHTML = '';
                    
                    if (Object.keys(works).length > 0) {
                        Object.entries(works).forEach(([year, workList]) => {
                            const div = document.createElement('div');
                            div.className = 'year-works';
                            div.innerHTML = `
                                <input type="text" class="form-control year-input" value="${year}">
                                <textarea class="form-control works-input">${Array.isArray(workList) ? workList.join('\n') : workList}</textarea>
                                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">âœ•</button>
                            `;
                            container.appendChild(div);
                        });
                    } else {
                        container.innerHTML = `
                            <div class="year-works">
                                <input type="text" class="form-control year-input" placeholder="ë…„ë„">
                                <textarea class="form-control works-input" placeholder="ì‘í’ˆëª… (ì—¬ëŸ¬ ì‘í’ˆì€ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)"></textarea>
                            </div>
                        `;
                    }
                });
            }
            
            document.getElementById('artistModal').style.display = 'block';
        }

        // Delete artist
        async function deleteArtist(artistId) {
            const artist = allArtists.find(a => a.id === artistId);
            if (!artist) {
                showStatus('ì•„í‹°ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            if (!confirm(`"${artist.name}" ì•„í‹°ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nëª¨ë“  ì´ë¯¸ì§€ì™€ ì •ë³´ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

            setLoading(true);
            try {
                console.log(`Attempting to delete artist: ${artistId}`);
                const response = await fetch(`/api/artists/${artistId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log(`Delete response status: ${response.status}`);
                
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorText = await response.text();
                        if (errorText) {
                            errorMessage += `: ${errorText}`;
                        }
                    } catch (e) {
                        console.log('Could not read error response text');
                    }
                    throw new Error(errorMessage);
                }
                
                // Try to parse response if there is any content
                try {
                    const result = await response.text();
                    if (result) {
                        console.log('Delete response:', result);
                    }
                } catch (e) {
                    console.log('No response body or failed to parse');
                }
                
                showStatus(`"${artist.name}" ì•„í‹°ìŠ¤íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                await refreshArtistsList();
                
            } catch (error) {
                console.error('Error deleting artist:', error);
                
                // Check for specific error types
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showStatus('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else if (error.message.includes('404')) {
                    showStatus('ì•„í‹°ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ ì‚­ì œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
                } else if (error.message.includes('403')) {
                    showStatus('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                } else if (error.message.includes('405')) {
                    showStatus('ì„œë²„ê°€ DELETE ìš”ì²­ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.', 'error');
                } else if (error.message.includes('500')) {
                    showStatus('ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.', 'error');
                } else {
                    showStatus('ì•„í‹°ìŠ¤íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                }
            } finally {
                setLoading(false);
            }
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(allArtists, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `arclead-artists-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Import data
        async function importData(input) {
            const file = input.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const importedArtists = JSON.parse(text);
                
                if (!Array.isArray(importedArtists)) {
                    throw new Error('ì˜ëª»ëœ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.');
                }

                if (confirm(`${importedArtists.length}ëª…ì˜ ì•„í‹°ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.`)) {
                    // Here you would send the data to the server
                    showStatus(`${importedArtists.length}ëª…ì˜ ì•„í‹°ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`, 'success');
                }
                
            } catch (error) {
                showStatus('íŒŒì¼ì„ ì½ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
            
            input.value = '';
        }

        // Manual refresh function
        async function manualRefresh() {
            console.log('Manual refresh triggered');
            setLoading(true);
            const success = await refreshArtistsList();
            if (success) {
                showStatus(`${allArtists.length}ëª…ì˜ ì•„í‹°ìŠ¤íŠ¸ë¥¼ ìƒˆë¡œê³ ì¹¨í–ˆìŠµë‹ˆë‹¤.`, 'success');
                console.log('Manual refresh completed successfully');
            } else {
                console.log('Manual refresh failed');
            }
            setLoading(false);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            setLoading(true);
            const success = await refreshArtistsList();
            if (success) {
                showStatus(`${allArtists.length}ëª…ì˜ ì•„í‹°ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
            }
            setLoading(false);
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('artistModal');
            if (event.target === modal) {
                closeArtistModal();
            }
        }
    </script>
</body>
</html> 